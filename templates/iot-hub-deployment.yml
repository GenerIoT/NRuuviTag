  jobs:
    - job: deploy_to_iot_hub
      variables:
        - group: IoTDeployment
        - group: DockerLogin

      steps:

        - script: |
            VERSION=$(VERSION)
            MODULE_NAME=$(MODULE_NAME)
            ACR_NAME=$(ACR_NAME)
            LOGIN_SERVER=$(LOGIN_SERVER)
            IMAGE_NAME=$(IMAGE_NAME)
            USERNAME=$(USERNAME)
            PASSWORD=$(PASSWORD)
            DEVICE_CONNECTION_STRING=$(DEVICE_CONNECTION_STRING)

            cat <<EOF > deployment.json
            {
              "content": {
                "modulesContent": {
                  "\$edgeAgent": {
                    "properties.desired": {
                      "modules": {
                        "$MODULE_NAME": {
                          "type": "docker",
                          "settings": {
                            "image": "$LOGIN_SERVER/$IMAGE_NAME:$VERSION",
                            "createOptions": "{\"HostConfig\":{\"Binds\":[\"/var/run/dbus:/var/run/dbus\"],\"Privileged\":true}}"
                          },
                          "env": {
                            "ConnectionString": { "value": "$DEVICE_CONNECTION_STRING" }
                          },
                          "imagePullPolicy": "on-create",
                          "restartPolicy": "always",
                          "startupOrder": 100
                        }
                      },
                      "runtime": {
                        "settings": {
                          "registryCredentials": {
                            "$ACR_NAME": {
                              "address": "$LOGIN_SERVER",
                              "username": "$USERNAME",
                              "password": "$PASSWORD"
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
            EOF
              displayName: "Create IoT Edge deployment manifest"

        - task: AzureCLI@2
          inputs:
            azureSubscription: 'GenerIoT-Demo-CICD-Secret'  # <-- replace with your service connection name
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              az extension add --name azure-iot

              VERSION=$(VERSION)
              TIMESTAMP=$(date -u +"%Y%m%d%H%M%S")
              PRIORITY=${TIMESTAMP:1:10} 

              echo "=== DEBUG INFO ==="
              echo "TIMESTAMP: $TIMESTAMP"
              echo "PRIORITY : $PRIORITY"
              echo "DEPLOYMENT_ID: $(DEPLOYMENT_ID)-$VERSION"
              echo "TARGET_CONDITION: $(TARGET_CONDITION)"
              echo "IOTHUB_NAME: $(IOTHUB_NAME)"
              echo "Deployment JSON (./deployment.json):"
              cat ./deployment.json
              echo "=================="
            
              az iot edge deployment create \
                --hub-name $(IOTHUB_NAME) \
                --content ./deployment.json \
                --deployment-id "$(DEPLOYMENT_ID)-$VERSION" \
                --target-condition "$(TARGET_CONDITION)" \
                --priority $PRIORITY \
                --labels "{\"tag\":\"$VERSION\",\"cicd\":\"true\",\"source\":\"azure-devops\"}"
            displayName: "Deploy IoT Edge module"