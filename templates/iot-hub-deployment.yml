  jobs:
    - job: deploy_to_iot_hub
      variables:
        - group: IoTDeployment
        - group: DockerLogin

      steps:
        - task: AzureCLI@2
          displayName: "Azure Login via Service Connection"
          inputs:
            azureSubscription: 'GenerIoT-Demo-CICD-Secret'  # <-- replace with your service connection name
            scriptType: bash
            scriptLocation: inlineScript
            inlineScript: |
              echo "Logged into Azure"
              az account show

        - script: |
            az extension add --name azure-iot
          displayName: "Install Azure IoT extension"

        - script: |
            VERSION=$(VERSION)

            cat <<EOF > deployment.json
            {
              "content": {
                "modulesContent": {
                  "\$edgeAgent": {
                    "properties.desired.modules.$(MODULE_NAME)": {
                      "env": {
                        "ConnectionString": {
                          "value": "$(DEVICE_CONNECTION_STRING)"
                        }
                      },
                      "imagePullPolicy": "on-create",
                      "restartPolicy": "always",
                      "settings": {
                        "image": "$(LOGIN_SERVER)/$(IMAGE_NAME):$VERSION",
                        "createOptions": "{\"HostConfig\":{\"Binds\":[\"/var/run/dbus:/var/run/dbus\"],\"Privileged\":true}}"
                      },
                      "startupOrder": 100,
                      "type": "docker",
                      "status": "running"
                    },
                    "properties.desired.runtime.settings.registryCredentials.$(ACR_NAME)": {
                      "address": "$(LOGIN_SERVER)",
                      "username": "$(USERNAME)",
                      "password": "$(PASSWORD)"
                    }
                  }
                }
              }
            }
            EOF
          displayName: "üìù Create IoT Edge deployment manifest"

        # 4Ô∏è‚É£ Deploy to IoT Hub
        - script: |
            VERSION=$(dependencies.version_bump.outputs['setVersion.version'] || echo "latest")
            TIMESTAMP=$(date -u +"%Y-%m-%d-%H-%M-%S")
            PRIORITY=$(date -u +"%Y%m%d%H%M%S")

            az iot edge deployment create \
              --hub-name $(IOTHUB_NAME) \
              --content ./deployment.json \
              --deployment-id "$(DEPLOYMENT_ID)-$VERSION" \
              --target-condition "$(TARGET_CONDITION)" \
              --priority $PRIORITY \
              --labels "{\"tag\":\"$VERSION\",\"cicd\":\"true\",\"source\":\"azure-devops\"}"
          displayName: "Deploy IoT Edge module"